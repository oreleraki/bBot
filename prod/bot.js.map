{"version":3,"sources":["../src/bot.js"],"names":["dotenv","config","bBot","Client","disabledEvents","onMessage","message","author","equals","user","content","startsWith","prefix","id","username","roles","member","isInvisible","presence","status","serverId","guild","hasUserMention","mentions","users","first","mentionedUser","substring","length","split","filter","Boolean","args","action","toLowerCase","isSolo","offline","foundCommand","commands","find","cmd","solo","aliases","includes","handlers","key","channel","send","on","console","log","Date","toUTCString","_","state","store","getState","pugs","list","pugChannel","i","pug","isInPug","findPlayer","channels","get","Message","User","bot","attachments","Map","embeds","mongoose","connect","useNewUrlParser","poolSize","useFindAndModify","hydrateStore","login","process","env","DISCORD_BOT_TOKEN","DiscordServers","exec","dServers","UT99QueryServers","qServers","GameTypes","gameTypes","forEach","server_id","pug_channel","query_channel","dispatch","queryChannel","query_servers","Array","from","game_types","emitters","pugEventEmitter","pugEvents","captainsReady","name","p"],"mappings":"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","sourcesContent":["import '@babel/polyfill';\nimport dotenv from 'dotenv';\nimport mongoose from 'mongoose';\nimport { Client, User, Message } from 'discord.js';\nimport store from './store';\nimport {\n  INIT,\n  setQueryChannel,\n  setPugChannel,\n  assignQueryServers,\n  assignGameTypes,\n} from './store/actions';\nimport { DiscordServers, UT99QueryServers, GameTypes } from './models';\nimport { handlers, commands, emitters } from './commands';\nimport { sanitizeName } from './utils';\nimport { prefix, offline, pugEvents } from './constants';\nimport { formatBroadcastCaptainsReady } from './formats';\n\ndotenv.config();\n\nconst bBot = new Client({\n  disabledEvents: ['TYPING_START', 'CHANNEL_UPDATE', 'USER_UPDATE'],\n});\n\nasync function onMessage(message) {\n  if (message.author.equals(bBot.user)) return;\n  if (!message.content.startsWith(prefix)) return;\n\n  const { id, username } = message.author;\n  const roles = message.member ? message.member.roles : null;\n  const isInvisible = message.author.presence.status === 'offline';\n\n  const {\n    guild: { id: serverId },\n  } = message;\n\n  if (!serverId) return;\n\n  const hasUserMention = message.mentions.users.first();\n  const mentionedUser = hasUserMention\n    ? { id: hasUserMention.id, username: sanitizeName(hasUserMention.username) }\n    : null;\n\n  const [first, ...args] = message.content\n    .substring(prefix.length)\n    .split(' ')\n    .filter(Boolean);\n  const action = first && first.toLowerCase();\n  const isSolo = args[0] === offline || args.length === 0;\n\n  const foundCommand = commands.find(\n    cmd => cmd.solo === isSolo && cmd.aliases.includes(action)\n  );\n\n  if (foundCommand) {\n    return handlers[foundCommand.key](message, args, serverId, {\n      id,\n      roles,\n      username: sanitizeName(username),\n      mentionedUser,\n      isInvisible,\n    });\n  }\n  message.channel.send(`Command not found`);\n}\n\n/*\n * BOT\n *  EVENTS\n */\n\nbBot.on('ready', () => {\n  console.log(`Bot started running at ${new Date().toUTCString()}`);\n});\n\nbBot.on('message', onMessage);\n\nbBot.on('presenceUpdate', (_, { user, guild, presence: { status } }) => {\n  if (status === 'offline') {\n    const state = store.getState();\n    const { list = [], pugChannel } = state.pugs[guild.id] || {};\n    for (let i = 0; i < list.length; i++) {\n      const pug = list[i];\n      const isInPug = pug.findPlayer(user);\n\n      if (isInPug) {\n        const channel = guild.channels.get(pugChannel);\n        const message = new Message(\n          channel,\n          {\n            author: new User(bBot, {\n              bot: false,\n              id: user.id,\n              username: user.username,\n            }),\n            attachments: new Map(),\n            embeds: [],\n            content: 'lva',\n          },\n          bBot\n        );\n        handlers['leaveAllGameTypes'](message, [offline], guild.id, {\n          id: user.id,\n          username: sanitizeName(user.username),\n        });\n        break;\n      }\n    }\n  }\n});\n\n(async () => {\n  try {\n    await mongoose.connect('mongodb://localhost:27017/bBot', {\n      useNewUrlParser: true,\n      poolSize: 5,\n      useFindAndModify: false,\n    });\n    await hydrateStore();\n    bBot.login(process.env.DISCORD_BOT_TOKEN);\n  } catch (error) {\n    console.log('error', error);\n  }\n})();\n\nconst hydrateStore = async () => {\n  const dServers = await DiscordServers.find({}).exec();\n  const qServers = await UT99QueryServers.find({}).exec();\n  const gameTypes = await GameTypes.find({}).exec();\n\n  dServers.forEach(({ server_id, pug_channel, query_channel }) => {\n    store.dispatch(INIT({ serverId: server_id }));\n    store.dispatch(\n      setPugChannel({\n        serverId: server_id,\n        pugChannel: pug_channel,\n      })\n    );\n    store.dispatch(\n      setQueryChannel({ serverId: server_id, queryChannel: query_channel })\n    );\n  });\n\n  qServers.forEach(({ server_id, query_servers }) => {\n    store.dispatch(\n      assignQueryServers({\n        serverId: server_id,\n        list: Array.from(query_servers),\n      })\n    );\n  });\n\n  gameTypes.forEach(({ server_id, game_types }) => {\n    store.dispatch(\n      assignGameTypes({\n        serverId: server_id,\n        gameTypes: Array.from(game_types),\n      })\n    );\n  });\n};\n\n/**\n * P U G\n * E V E N T S\n */\nemitters.pugEventEmitter.on(pugEvents.captainsReady, (serverId, name) => {\n  const state = store.getState();\n  const { pugChannel, list } = state.pugs[serverId];\n  const pug = list.find(p => p.name === name);\n\n  bBot.channels.get(pugChannel).send(formatBroadcastCaptainsReady(pug));\n});\n"],"file":"bot.js"}